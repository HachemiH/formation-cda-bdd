# 5.6 Procédures Stockées et Requêtes Préparées dans PostgreSQL

<blockquote>
    <h2>Prérequis</h2>
    <ul>
        <li>Compréhension approfondie des opérations de base en SQL, incluant SELECT, INSERT, UPDATE, et DELETE.</li>
        <li>Expérience préalable avec la création et l'utilisation de fonctions simples dans PostgreSQL.</li>
        <li>Familiarité avec les concepts de gestion des transactions et d'optimisation des requêtes.</li>
    </ul>
</blockquote>

<blockquote>
    <h2>Objectifs pédagogiques</h2>
    <ul>
        <li>Comprendre les différences fondamentales entre les procédures stockées et les requêtes préparées.</li>
        <li>Apprendre à créer et utiliser des procédures stockées pour encapsuler la logique métier.</li>
        <li>Explorer l'utilisation des requêtes préparées pour améliorer la sécurité et l'efficacité des requêtes SQL.</li>
        <li>Examiner les avantages spécifiques de chaque méthode en termes de performance, de sécurité et de maintenabilité.</li>
    </ul>
</blockquote>

---


# 5.6 Procédures Stockées et Requêtes Préparées dans PostgreSQL

Dans le développement de bases de données PostgreSQL, les procédures stockées et les requêtes préparées sont deux fonctionnalités puissantes qui optimisent les opérations et renforcent la sécurité. Bien qu'elles puissent sembler similaires, elles servent des objectifs distincts et présentent des différences clés.

Les procédures stockées sont des ensembles d'instructions SQL sauvegardées qui peuvent être réutilisées et exécutées dans la base de données. Elles sont idéales pour encapsuler la logique métier, effectuer des opérations complexes et réduire le trafic réseau.

Les requêtes préparées, en revanche, sont des modèles de requêtes qui sont compilés une seule fois et peuvent être exécutés à plusieurs reprises avec des paramètres différents. Elles améliorent la performance en évitant la recompilation et augmentent la sécurité en prévenant les injections SQL.

## 5.6.1 Les requêtes préparées dans PostgreSQL

Les requêtes préparées sont un mécanisme essentiel dans PostgreSQL qui permet d'exécuter des requêtes SQL de manière plus sécurisée et efficace, en particulier lorsqu'elles sont utilisées à plusieurs reprises avec différents paramètres. Elles sont particulièrement utiles pour protéger contre les injections SQL, un type d'attaque où un attaquant tente d'exécuter des commandes malveillantes en exploitant des entrées utilisateur non validées.

### Introduction aux requêtes préparées

Une requête préparée, ou statement préparé, est une fonctionnalité qui permet de précompiler une requête SQL et de l'exécuter avec des paramètres variables. Cela offre deux avantages principaux :
1. **Performance améliorée** : La requête est compilée une seule fois mais peut être exécutée plusieurs fois, ce qui réduit le temps de traitement.
2. **Sécurité accrue** : En séparant les données des instructions SQL, les requêtes préparées empêchent l'exécution de code malveillant, protégeant ainsi contre les injections SQL.

### Syntaxe de base

La syntaxe pour créer une requête préparée dans PostgreSQL implique généralement deux étapes :
1. **Préparation de la requête** : Définir la structure de la requête SQL, avec des espaces réservés pour les valeurs des paramètres.
2. **Exécution de la requête** : Fournir les valeurs réelles des paramètres et exécuter la requête.

```sql
PREPARE user_email_query (text) AS
    SELECT * FROM users WHERE email = $1;
```
- **Explication** : Cette commande prépare une requête pour sélectionner des utilisateurs basée sur l'email. `$1` est un paramètre qui sera remplacé par une valeur spécifique lors de l'exécution.

```sql
EXECUTE user_email_query('example@email.com');
```
- **Explication** : Exécute la requête préparée avec 'example@email.com' comme valeur pour le paramètre `$1`.

### Exemple de requête vulnérable à l'injection SQL et sa version sécurisée

#### Version vulnérable

```sql
-- Requête SQL vulnérable à l'injection
SELECT * FROM users WHERE username = 'admin' -- ';
```
- **Explication** : Cette requête est vulnérable car un attaquant pourrait insérer `' OR '1'='1` pour manipuler la condition de telle sorte que la requête retourne tous les utilisateurs.

#### Version sécurisée avec requête préparée

```sql
-- Préparation de la requête sécurisée
PREPARE secure_login (text, text) AS
    SELECT * FROM users WHERE username = $1 AND password = $2;

-- Exécution de la requête sécurisée
EXECUTE secure_login('admin', 'password123');
```
- **Explication** : Cette version utilise une requête préparée où le nom d'utilisateur et le mot de passe sont passés comme paramètres, empêchant toute modification malveillante de la requête initiale.

### Avantages des requêtes préparées pour les débutants

1. **Simplicité** : Les requêtes préparées simplifient le processus de codage en séparant la logique SQL de la manipulation des données.
2. **Sécurité** : Elles offrent une protection robuste contre les injections SQL, un des risques de sécurité les plus courants dans le développement web.
3. **Apprentissage** : Comprendre et utiliser les requêtes préparées aide les débutants à développer de bonnes pratiques de programmation sécurisée dès le début.


### Gestion des Requêtes par les ORMs

1. **Requêtes Préparées** : 
   - La plupart des ORMs modernes utilisent des requêtes préparées (ou paramétrées) comme mécanisme de défense principal contre les injections SQL. 
   - Les requêtes préparées séparent clairement le code SQL des données, empêchant les entrées malveillantes de modifier la logique SQL. Les valeurs des paramètres sont transmises au moment de l'exécution de la requête, et non au moment de sa compilation, ce qui empêche l'interprétation des données d'entrée comme du code SQL.

2. **Échappement Automatique des Entrées** :
   - En plus des requêtes préparées, les ORMs échappent automatiquement les entrées pour s'assurer que les caractères spéciaux sont traités de manière appropriée, ce qui réduit davantage le risque d'injections SQL.
   - Cette fonctionnalité transforme les données d'entrée de manière à ce qu'elles soient sûres à utiliser dans une requête SQL, en préfixant les caractères spéciaux qui pourraient autrement être interprétés comme une partie du code SQL.

3. **Abstraction des Requêtes SQL** :
   - Les ORMs permettent souvent de construire des requêtes SQL à l'aide de méthodes et de fonctions haut niveau, ce qui réduit les erreurs humaines dans la formulation des requêtes SQL et améliore la lisibilité et la maintenabilité du code.
   - Par exemple, au lieu d'écrire une requête SQL brute, un développeur peut utiliser des méthodes ORM pour spécifier les conditions de filtrage, les jointures, les tris, etc., de manière plus intuitive et sécurisée.

### Sécurité des Requêtes ORM

- **Par Conception** : Les ORMs sont conçus pour offrir une couche d'abstraction qui non seulement facilite l'interaction avec la base de données mais aussi renforce la sécurité. En encapsulant les détails de la construction des requêtes SQL et en s'appuyant sur des requêtes préparées, les ORMs contribuent à une base de code plus sûre.
- **Prévention des Injections SQL** : Grâce à l'utilisation systématique de requêtes préparées et à l'échappement des entrées, les ORMs offrent une protection robuste contre les injections SQL, un des risques de sécurité les plus courants dans les applications web.

En résumé, les ORMs gèrent les requêtes de manière à maximiser la sécurité et à minimiser les risques d'injections SQL. Ils utilisent des requêtes préparées et l'échappement automatique des entrées pour s'assurer que les interactions avec la base de données sont sécurisées. Cette approche permet aux développeurs de se concentrer davantage sur la logique métier tout en maintenant une interaction sécurisée avec la base de données.


